<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        
        <link href="styles.css" rel="stylesheet" type="text/css">
        
        <script src="jquery-2.1.0.min.js" type="text/javascript"></script>
        <script src="peer.min.js" type="text/javascript"></script>
        <script src="http://fb.me/react-0.12.2.js"></script>
        <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>
        
        <title>721 Vs.</title>
    </head>
    <body>
        <div id="container"></div>
        
        <script>
            var log = $("#log");
            var peer = new Peer({
                key: 'yd1nanm1c4fxyldi'
            });
            var conn = null;
            
            $(document).ready(function() {
                peer.on('open', function(id) {
                    $("#yourId").val(id);
                });
                
                function bindConnection(c) {
                    conn = c;
                    log.append("receinved connection<BR>");
                    
                    conn.on('open', function() {
                        conn.on('data', function(data) {
                            log.append(data + "<br>");
                        });
                    });
                }
                
                peer.on('connection', function(c) {
                    bindConnection(c);
                });
                
                $("#connect").bind('click', function(e) {
                    e.preventDefault();
                    
                    c = peer.connect($("#friendId").val());
                    bindConnection(c);
                });
                
                $("#send").bind('click', function(e) {
                    e.preventDefault();
                    
                    conn.send($("#message").val());
                });
            });
        </script>
        <script type="text/jsx">
            var GuessableItem = React.createClass({
                render: function() {
                    var itemClasses = "pokemon"
                    var imgClasses = ""
                    if (!this.props.guessableItem.guessed) {
                        itemClasses = itemClasses + " unown";
                        imgClasses = "hidden"
                    }
                    return (
                        <div id={this.props.guessableItem.pokedexNumber} name={this.props.guessableItem.pokemonName} className={itemClasses}> 
                            {this.props.guessableItem.pokedexNumber}.&nbsp;
                            <span className={imgClasses}>{this.props.guessableItem.pokemonName}<img src={"http://www.serebii.net/xy/pokemon/" + this.props.guessableItem.pokedexNumber + ".png"}></img></span>
                        </div>
                    );
                }
            });
            
            var GuessableList = React.createClass({
                render: function() {
                    var guessableItems = this.props.guessableList.map(function (guessableItem) {
                        return (
                            <GuessableItem key={guessableItem.pokedexNumber} guessableItem={guessableItem} />
                        );
                    });
                    return (
                        <div className="guessableList">
                            {guessableItems}
                        </div>
                    );
                }
            });
            
            var GuessBox = React.createClass({
                render: function() {
                    return (
                        <form onSubmit={this.handleGuess}>
                            <input type="text" placeholder="Type your guess here." ref="guess"></input>
                            <input type="submit" value="Send"></input>
                        </form>
                    );
                },
                handleGuess: function(e) {
                    e.preventDefault();
                    var guess = this.refs.guess.getDOMNode().value.trim();
                    if (!guess) {
                        return;
                    }
                    this.props.registerGuess(guess);
                    this.refs.guess.getDOMNode().value = '';
                }
            });
            
            var ConnectPanel = React.createClass({
                getInitialState: function() {
                    return {
                        key: "yd1nanm1c4fxyldi",
                        yourId: null,
                        friendId: null,
                        conn: null
                    };
                },
                render: function() {
                    return (
                        <form onSubmit={this.handleConnect}>
                            Your ID: <input type="text" ref="yourId" disabled value={this.state.yourId}></input><br />
                            Friend ID: <input type="text" ref="friendId"></input><br />
                            <input type="submit" value="Connect" ></input>
                        </form>
                    );
                },
                handleConnect: function(e) {
                    e.preventDefault();
                    
                    var c = peer.connect(this.refs.friendId.getDOMNode().value.trim());
                    this.bindConnection(c);
                },
                componentDidMount: function() {
                var self = this;
                    var peer = new Peer({
                        key: self.state.key
                    });
                    
                    peer.on('open', function(id) {
                        var tempState = self.state;
                        tempState.yourId = id;
                        self.setState(tempState);
                    });
                    
                    peer.on('connection', function(c) {
                        self.bindConnection(c);
                    });
                },
                bindConnection: function(c) {
                    var self = this;
                    c.on('open', function() {
                        c.on('data', function(data) {
                            self.props.onOpponentGuess(data);
                        });
                    });
                    
                    this.state.conn = c;
                },
                componentWillReceiveProps: function (newProps) {
                    if(this.state.conn) {
                        this.state.conn.send(newProps.guess);
                    }
                }
            });
            
            var GuessableGame = React.createClass({
                getInitialState: function() {
                    return {
                        data:{
                            guessableList: [
                                {
                                    pokedexNumber: "001",
                                    pokemonName: "Bulbasaur",
                                    guessed: false
                                },
                                {
                                    pokedexNumber: "002",
                                    pokemonName: "Ivysaur",
                                    guessed: false
                                },
                                {
                                    pokedexNumber: "003",
                                    pokemonName: "Venusaur",
                                    guessed: false
                                }
                            ],
                            guessToListMap: {
                                bulbasaur: 0,
                                ivysaur: 1,
                                venusaur: 2
                            },
                            guess: null
                        }
                    };
                },
                render: function() {
                    return (
                        <div>
                            <ConnectPanel guess={this.state.data.guess} onOpponentGuess={this.onOpponentGuess} />
                            <br />
                            <GuessBox registerGuess={this.onGuess} />
                            <GuessableList guessableList={this.state.data.guessableList} />
                        </div>
                    );
                },
                onGuess: function(guess) {
                    var tempState = this.state;
                    if (tempState.data.guessToListMap.hasOwnProperty(guess)) {
                        tempState.data.guessableList[tempState.data.guessToListMap[guess]].guessed = true;
                        tempState.data.guess = guess;
                        
                        this.setState(tempState);
                    }
                },
                onOpponentGuess: function(guess) {
                    var tempState = this.state;
                    if (tempState.data.guessToListMap.hasOwnProperty(guess)) {
                        tempState.data.guessableList[tempState.data.guessToListMap[guess]].guessed = true;
                        
                        this.setState(tempState);
                    }
                }
            });
            
            React.render(
                <GuessableGame />,
                document.getElementById('container')
            );
        </script>
    </body>
</html>